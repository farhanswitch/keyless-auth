import axios, { AxiosError } from 'axios';
import { existsSync, readFileSync, writeFileSync } from 'fs';

const ASRF =
  'eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI1VmxtNFdsQkRiMFNiZUwwNDlySEVIaG44WHBWOVlaWlVxMmFLc0s5Z2dJIn0.eyJleHAiOjE2ODUwOTA5ODYsImlhdCI6MTY4NTA2OTM4NiwianRpIjoiYjM4ZjZhY2MtODIzYy00OTJmLTgwMTMtZmI4ZmFjNzJmMjFmIiwiaXNzIjoiaHR0cDovL2hvc3QuZG9ja2VyLmludGVybmFsOjgwODAvcmVhbG1zL3JlZ29sLWVmb3JtIiwiYXVkIjpbInJlYWxtLW1hbmFnZW1lbnQiLCJicm9rZXIiLCJhY2NvdW50Il0sInN1YiI6IjA3MzQ2ZDE5LWRlNDYtNDZjNS1hNjQyLTJmN2ZiMTkyODMwYiIsInR5cCI6IkJlYXJlciIsImF6cCI6Im11c2VlLWR1LWxvdXZyZSIsInNlc3Npb25fc3RhdGUiOiIwMWJhOWJkNy00MmQxLTRhNmEtODQzMy1kODUwNGYxMGE0MGMiLCJhY3IiOiIxIiwicmVhbG1fYWNjZXNzIjp7InJvbGVzIjpbIkFuYWx5dGljcy1vbmx5IiwicmVhbG0tYWRtaW4iLCJkZWZhdWx0LXJvbGVzLXJlZ29sLWVmb3JtIiwib2ZmbGluZV9hY2Nlc3MiLCJ1bWFfYXV0aG9yaXphdGlvbiJdfSwicmVzb3VyY2VfYWNjZXNzIjp7InJlYWxtLW1hbmFnZW1lbnQiOnsicm9sZXMiOlsidmlldy1yZWFsbSIsInZpZXctaWRlbnRpdHktcHJvdmlkZXJzIiwibWFuYWdlLWlkZW50aXR5LXByb3ZpZGVycyIsImltcGVyc29uYXRpb24iLCJyZWFsbS1hZG1pbiIsImNyZWF0ZS1jbGllbnQiLCJtYW5hZ2UtdXNlcnMiLCJxdWVyeS1yZWFsbXMiLCJ2aWV3LWF1dGhvcml6YXRpb24iLCJxdWVyeS1jbGllbnRzIiwicXVlcnktdXNlcnMiLCJtYW5hZ2UtZXZlbnRzIiwibWFuYWdlLXJlYWxtIiwidmlldy1ldmVudHMiLCJ2aWV3LXVzZXJzIiwidmlldy1jbGllbnRzIiwibWFuYWdlLWF1dGhvcml6YXRpb24iLCJtYW5hZ2UtY2xpZW50cyIsInF1ZXJ5LWdyb3VwcyJdfSwibXVzZWUtZHUtbG91dnJlIjp7InJvbGVzIjpbImJyb2tlci12aWV3Iiwicm9sZXMtZWRpdCIsInN1Y2Nlc3Mtc2VuZHN1cHBvcnRpbmdkb2N1bWVudCIsImNvbXBhbnliYW5rLWRlbGV0ZSIsImNkZG1hbmFnZW1lbnQtZWRpdCIsInN1Y2Nlc3Mtdmlld2N1c3RvbWVyIiwiYnJva2VyLWFkZCIsImxpc3QtZGVsZXRlIiwiY3VzdG9tZXJyaXNrcHJvZmlsZS1yZWNhbGN1bGF0ZWFsbHJpc2siLCJjb21wYW55LXZpZXciLCJzdWNjZXNzLWRvd25sb2Fkc3VyYXRwZXJqYW5qaWFuIiwiYW5hbHl0aWNzLWV4cG9ydCIsInJlZ2lzdHJhdGlvbi1zZW5kZGVtb2FjY291bnQiLCJzdWNjZXNzLWVtYWlsaGlzdG9yeSIsImxpc3QtcHJpbnQiLCJ0ZWxlZ3JhbXN0YXR1cy12aWV3Iiwicm9sZXMtYWRkIiwic3VjY2Vzcy1lZGl0c2UxMWVtYWlsIiwicmlza21hbmFnZW1lbnQtdmlld2hpc3RvcnkiLCJyb2xlcy12aWV3IiwiZGVtb2FjY291bnQtdmlld2hpc3RvcnkiLCJkYi1ub3ciLCJyZWdpc3RyYXRpb24tcHJpbnQiLCJyZWdpc3RyYXRpb24tZWRpdCIsImNkZG1hbmFnZW1lbnQtYWRkIiwiYnJhbmNoLXZpZXdoaXN0b3J5IiwiZGVtb2FjY291bnQtZWRpdCIsInByb3ZpbmNlbWFuYWdlbWVudC12aWV3aGlzdG9yeSIsImJyb2tlci12aWV3aGlzdG9yeSIsImFuYWx5dGljcy12aWV3Iiwic3VjY2Vzcy1jdXN0b21lcmRhdGFoaXN0b3J5IiwidGFibGUtZWRpdCIsImNvbXBhbnktdmlld2hpc3RvcnkiLCJkZW1vYWNjb3VudC1hZGQiLCJwcm92aW5jZW1hbmFnZW1lbnQtdmlldyIsImVtYWlsLXByaW50IiwiY29tcGFueS1lZGl0IiwiZW1haWwtdmlld2hpc3RvcnkiLCJkZW1vYWNjb3VudC12aWV3IiwiY29udmVudGlvbmFsY3VzdG9tZXItdmlld2hpc3RvcnkiLCJjZGRtYW5hZ2VtZW50LWRlbGV0ZSIsImRlbW9hY2NvdW50LXF1ZXVlcmVhZHl0b3JlY3ljbGUiLCJjZGRtYW5hZ2VtZW50LXZpZXciLCJyZWdpc3RyYXRpb24tdmlldyIsInN1Y2Nlc3MtZG93bmxvYWRvdXRwdXQiLCJ1c2Vycy1lZGl0IiwiY29tcGFueWJhbmstYWRkIiwiY3VzdG9tZXJyaXNrcHJvZmlsZS1yZWNhbGN1bGF0ZXJpc2siLCJzdWNjZXNzLXByaW50Iiwic3VjY2Vzcy1pbnB1dHJlc3VtZSIsImluYWN0aXZlLXJlc3RyaWN0YWNjZXNzIiwiZG9jdW1lbnQtZWRpdCIsInVzZXJzLWNoYW5nZXBhc3N3b3JkIiwibGlzdC1yZXN0cmljdGFjY2VzcyIsImVtYWlsLWVkaXQiLCJ1c2Vycy1hdXRob3JpemVkYWRtaW4iLCJkYXNoYm9hcmQtdmlldyIsImluYWN0aXZlLXJlY292ZXJpbmFjdGl2ZWFjY291bnQiLCJzdWNjZXNzLXZpZXciLCJjdXN0b21lcnJpc2twcm9maWxlLWVkaXQiLCJjZGRtYW5hZ2VtZW50LXZpZXdoaXN0b3J5IiwiYnJhbmNoLWVkaXQiLCJ0YWJsZS12aWV3IiwidXNlcnMtdmlldyIsInN1Y2Nlc3MtZGVsZXRlIiwibGlzdC1zZW5kc3VwcG9ydGluZ2RvY3VtZW50IiwicHJvdmluY2VtYW5hZ2VtZW50LWRlbGV0ZSIsInN1Y2Nlc3MtZWRpdHZlcmlmaWNhdG9yIiwiZW1haWxzdGF0dXMtdmlldyIsImJyb2tlci1kZWxldGUiLCJyZWdpc3RyYXRpb25jb250ZW50LXZpZXciLCJkZW1vYWNjb3VudC1kZWxldGUiLCJsaXN0LXNlbmRzZTExIiwicmVnaXN0cmF0aW9uLWRlbGV0ZSIsImxpc3Qtdmlld2N1c3RvbWVyIiwic3VjY2Vzcy1zZW5kZG9jdW1lbnR0b2N1c3RvbWVyIiwic3VjY2Vzcy1yZXNlbmRlbWFpbHRvY3VzdG9tZXIiLCJsaXN0LWVkaXRzZTExZW1haWwiLCJjb252ZW50aW9uYWxjdXN0b21lci12aWV3IiwidW1hX3Byb3RlY3Rpb24iLCJjdXN0b21lcnJpc2twcm9maWxlLXZpZXciLCJsaXN0LXZpZXdwaWFsYW5nIiwibGlzdC1lZGl0aW5wdXRyZXN1bWUiLCJ1c2Vycy1hZGQiLCJicm9rZXItcHJpbnQiLCJlbWFpbC12aWV3IiwibGlzdC12ZXJpZmljYXRpb24iLCJyZWdpc3RyYXRpb25jb250ZW50LWVkaXQiLCJzdWNjZXNzLWVkaXRhcHVwcHRwcm92aW5jZSIsImxpc3QtZW1haWxoaXN0b3J5IiwibGlzdC1lZGl0dmVyaWZpY2F0b3IiLCJicmFuY2gtZGVsZXRlIiwicm9sZXMtZGVsZXRlIiwic3VjY2Vzcy1lZGl0aW5wdXRyZXN1bWUiLCJzdWNjZXNzLXNlbmRkb2N1bWVudHRvcGlhbGFuZyJdfSwiYnJva2VyIjp7InJvbGVzIjpbInJlYWQtdG9rZW4iXX0sImFjY291bnQiOnsicm9sZXMiOlsibWFuYWdlLWFjY291bnQiLCJ2aWV3LWFwcGxpY2F0aW9ucyIsInZpZXctY29uc2VudCIsInZpZXctZ3JvdXBzIiwibWFuYWdlLWFjY291bnQtbGlua3MiLCJkZWxldGUtYWNjb3VudCIsIm1hbmFnZS1jb25zZW50Iiwidmlldy1wcm9maWxlIl19fSwic2NvcGUiOiJlbWFpbCBwcm9maWxlIiwic2lkIjoiMDFiYTliZDctNDJkMS00YTZhLTg0MzMtZDg1MDRmMTBhNDBjIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsIm5hbWUiOiJTd2l0Y2ggU2tldGNoIiwicHJlZmVycmVkX3VzZXJuYW1lIjoic3dpdGNoIiwiZ2l2ZW5fbmFtZSI6IlN3aXRjaCIsImZhbWlseV9uYW1lIjoiU2tldGNoIiwiZW1haWwiOiJmYXJoYW5za2V0Y2hAZ21haWwuY29tIn0.gZsvc09OAMbB0oB__D_OwryuVN_TPTxqbzny-Cbd3n7cOPs9ZTDXmccvL9XUZmGhiVtXPu3Q8UjFrNipswYUWbvmH9fNq4dFAsx7ofWa4LF75u4NObbvAUCC7WeOP20ULlR5uqbtMxTvIoJwkMYWTEauINb1nah_gx_32FYyXEpg0ia5Qpjqjn0uYNohkj-4H_WxSf3BquNLXknkBwzs3hQ5-OFgwgvIwy4fsQmMvd6LT29BiAZoKYHXK6VSTZCEBPS3cetww-57a8JCvN7u-XJKS5MO-XVylgc5o5FYNET5xPTkqA-4ccjlw_QlGiECauxSnDck_7mkkmS_oo2jvA';

async function validatingAccess(token: string, resourceID: string) {
  try {
    const { data } = await axios.post(
      `http://localhost:4646/auth/validate-access`,
      {
        destinationURL: resourceID,
        token,
      },
    );
    return data;
  } catch (error) {
    return (error as AxiosError)?.response?.data;
  }
}

(async function () {
  // await axios.post(
  //   "http://localhost:8080/realms/regol-eform/authz/protection/resource_set?uri=/api/analytics",
  //   {},
  //   {
  //     headers: {
  //       Authorization:
  //         "eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI1VmxtNFdsQkRiMFNiZUwwNDlySEVIaG44WHBWOVlaWlVxMmFLc0s5Z2dJIn0.eyJleHAiOjE2ODUwMjg3MzgsImlhdCI6MTY4NTAwNzEzOCwianRpIjoiNjBkZTQ3MTktYTZjZi00YzQ2LWIyMGQtNzYwMDI1Y2M5NjExIiwiaXNzIjoiaHR0cDovL2hvc3QuZG9ja2VyLmludGVybmFsOjgwODAvcmVhbG1zL3JlZ29sLWVmb3JtIiwiYXVkIjpbInJlYWxtLW1hbmFnZW1lbnQiLCJicm9rZXIiLCJhY2NvdW50Il0sInN1YiI6IjA3MzQ2ZDE5LWRlNDYtNDZjNS1hNjQyLTJmN2ZiMTkyODMwYiIsInR5cCI6IkJlYXJlciIsImF6cCI6Im11c2VlLWR1LWxvdXZyZSIsInNlc3Npb25fc3RhdGUiOiI5ZDAxZDNlYi00MTc2LTRiNWYtYWYyNC01ZTdjZTQ2MTk0OGUiLCJhY3IiOiIxIiwicmVhbG1fYWNjZXNzIjp7InJvbGVzIjpbInJlYWxtLWFkbWluIiwiZGVmYXVsdC1yb2xlcy1yZWdvbC1lZm9ybSIsIm9mZmxpbmVfYWNjZXNzIiwidW1hX2F1dGhvcml6YXRpb24iXX0sInJlc291cmNlX2FjY2VzcyI6eyJyZWFsbS1tYW5hZ2VtZW50Ijp7InJvbGVzIjpbInZpZXctcmVhbG0iLCJ2aWV3LWlkZW50aXR5LXByb3ZpZGVycyIsIm1hbmFnZS1pZGVudGl0eS1wcm92aWRlcnMiLCJpbXBlcnNvbmF0aW9uIiwicmVhbG0tYWRtaW4iLCJjcmVhdGUtY2xpZW50IiwibWFuYWdlLXVzZXJzIiwicXVlcnktcmVhbG1zIiwidmlldy1hdXRob3JpemF0aW9uIiwicXVlcnktY2xpZW50cyIsInF1ZXJ5LXVzZXJzIiwibWFuYWdlLWV2ZW50cyIsIm1hbmFnZS1yZWFsbSIsInZpZXctZXZlbnRzIiwidmlldy11c2VycyIsInZpZXctY2xpZW50cyIsIm1hbmFnZS1hdXRob3JpemF0aW9uIiwibWFuYWdlLWNsaWVudHMiLCJxdWVyeS1ncm91cHMiXX0sIm11c2VlLWR1LWxvdXZyZSI6eyJyb2xlcyI6WyJicm9rZXItdmlldyIsInJvbGVzLWVkaXQiLCJzdWNjZXNzLXNlbmRzdXBwb3J0aW5nZG9jdW1lbnQiLCJjb21wYW55YmFuay1kZWxldGUiLCJjZGRtYW5hZ2VtZW50LWVkaXQiLCJzdWNjZXNzLXZpZXdjdXN0b21lciIsImJyb2tlci1hZGQiLCJsaXN0LWRlbGV0ZSIsImN1c3RvbWVycmlza3Byb2ZpbGUtcmVjYWxjdWxhdGVhbGxyaXNrIiwiY29tcGFueS12aWV3Iiwic3VjY2Vzcy1kb3dubG9hZHN1cmF0cGVyamFuamlhbiIsInJlZ2lzdHJhdGlvbi1zZW5kZGVtb2FjY291bnQiLCJzdWNjZXNzLWVtYWlsaGlzdG9yeSIsImxpc3QtcHJpbnQiLCJ0ZWxlZ3JhbXN0YXR1cy12aWV3Iiwicm9sZXMtYWRkIiwic3VjY2Vzcy1lZGl0c2UxMWVtYWlsIiwicmlza21hbmFnZW1lbnQtdmlld2hpc3RvcnkiLCJyb2xlcy12aWV3IiwiZGVtb2FjY291bnQtdmlld2hpc3RvcnkiLCJyZWdpc3RyYXRpb24tcHJpbnQiLCJyZWdpc3RyYXRpb24tZWRpdCIsImNkZG1hbmFnZW1lbnQtYWRkIiwiYnJhbmNoLXZpZXdoaXN0b3J5IiwiZGVtb2FjY291bnQtZWRpdCIsInByb3ZpbmNlbWFuYWdlbWVudC12aWV3aGlzdG9yeSIsImJyb2tlci12aWV3aGlzdG9yeSIsImFuYWx5dGljcy12aWV3Iiwic3VjY2Vzcy1jdXN0b21lcmRhdGFoaXN0b3J5IiwidGFibGUtZWRpdCIsImNvbXBhbnktdmlld2hpc3RvcnkiLCJkZW1vYWNjb3VudC1hZGQiLCJwcm92aW5jZW1hbmFnZW1lbnQtdmlldyIsImVtYWlsLXByaW50IiwiY29tcGFueS1lZGl0IiwiZW1haWwtdmlld2hpc3RvcnkiLCJkZW1vYWNjb3VudC12aWV3IiwiY29udmVudGlvbmFsY3VzdG9tZXItdmlld2hpc3RvcnkiLCJjZGRtYW5hZ2VtZW50LWRlbGV0ZSIsImRlbW9hY2NvdW50LXF1ZXVlcmVhZHl0b3JlY3ljbGUiLCJjZGRtYW5hZ2VtZW50LXZpZXciLCJyZWdpc3RyYXRpb24tdmlldyIsInN1Y2Nlc3MtZG93bmxvYWRvdXRwdXQiLCJ1c2Vycy1lZGl0IiwiY29tcGFueWJhbmstYWRkIiwiY3VzdG9tZXJyaXNrcHJvZmlsZS1yZWNhbGN1bGF0ZXJpc2siLCJzdWNjZXNzLXByaW50Iiwic3VjY2Vzcy1pbnB1dHJlc3VtZSIsImluYWN0aXZlLXJlc3RyaWN0YWNjZXNzIiwiZG9jdW1lbnQtZWRpdCIsInVzZXJzLWNoYW5nZXBhc3N3b3JkIiwibGlzdC1yZXN0cmljdGFjY2VzcyIsImVtYWlsLWVkaXQiLCJ1c2Vycy1hdXRob3JpemVkYWRtaW4iLCJkYXNoYm9hcmQtdmlldyIsImluYWN0aXZlLXJlY292ZXJpbmFjdGl2ZWFjY291bnQiLCJzdWNjZXNzLXZpZXciLCJjdXN0b21lcnJpc2twcm9maWxlLWVkaXQiLCJjZGRtYW5hZ2VtZW50LXZpZXdoaXN0b3J5IiwiYnJhbmNoLWVkaXQiLCJ0YWJsZS12aWV3IiwidXNlcnMtdmlldyIsInN1Y2Nlc3MtZGVsZXRlIiwibGlzdC1zZW5kc3VwcG9ydGluZ2RvY3VtZW50IiwicHJvdmluY2VtYW5hZ2VtZW50LWRlbGV0ZSIsInN1Y2Nlc3MtZWRpdHZlcmlmaWNhdG9yIiwiZW1haWxzdGF0dXMtdmlldyIsImJyb2tlci1kZWxldGUiLCJyZWdpc3RyYXRpb25jb250ZW50LXZpZXciLCJkZW1vYWNjb3VudC1kZWxldGUiLCJsaXN0LXNlbmRzZTExIiwicmVnaXN0cmF0aW9uLWRlbGV0ZSIsImxpc3Qtdmlld2N1c3RvbWVyIiwic3VjY2Vzcy1zZW5kZG9jdW1lbnR0b2N1c3RvbWVyIiwic3VjY2Vzcy1yZXNlbmRlbWFpbHRvY3VzdG9tZXIiLCJsaXN0LWVkaXRzZTExZW1haWwiLCJjb252ZW50aW9uYWxjdXN0b21lci12aWV3IiwidW1hX3Byb3RlY3Rpb24iLCJjdXN0b21lcnJpc2twcm9maWxlLXZpZXciLCJsaXN0LXZpZXdwaWFsYW5nIiwibGlzdC1lZGl0aW5wdXRyZXN1bWUiLCJ1c2Vycy1hZGQiLCJicm9rZXItcHJpbnQiLCJlbWFpbC12aWV3IiwibGlzdC12ZXJpZmljYXRpb24iLCJyZWdpc3RyYXRpb25jb250ZW50LWVkaXQiLCJzdWNjZXNzLWVkaXRhcHVwcHRwcm92aW5jZSIsImxpc3QtZW1haWxoaXN0b3J5IiwibGlzdC1lZGl0dmVyaWZpY2F0b3IiLCJicmFuY2gtZGVsZXRlIiwicm9sZXMtZGVsZXRlIiwic3VjY2Vzcy1lZGl0aW5wdXRyZXN1bWUiLCJzdWNjZXNzLXNlbmRkb2N1bWVudHRvcGlhbGFuZyJdfSwiYnJva2VyIjp7InJvbGVzIjpbInJlYWQtdG9rZW4iXX0sImFjY291bnQiOnsicm9sZXMiOlsibWFuYWdlLWFjY291bnQiLCJ2aWV3LWFwcGxpY2F0aW9ucyIsInZpZXctY29uc2VudCIsInZpZXctZ3JvdXBzIiwibWFuYWdlLWFjY291bnQtbGlua3MiLCJkZWxldGUtYWNjb3VudCIsIm1hbmFnZS1jb25zZW50Iiwidmlldy1wcm9maWxlIl19fSwic2NvcGUiOiJlbWFpbCBwcm9maWxlIiwic2lkIjoiOWQwMWQzZWItNDE3Ni00YjVmLWFmMjQtNWU3Y2U0NjE5NDhlIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsIm5hbWUiOiJTd2l0Y2ggU2tldGNoIiwicHJlZmVycmVkX3VzZXJuYW1lIjoic3dpdGNoIiwiZ2l2ZW5fbmFtZSI6IlN3aXRjaCIsImZhbWlseV9uYW1lIjoiU2tldGNoIiwiZW1haWwiOiJmYXJoYW5za2V0Y2hAZ21haWwuY29tIn0.weGhRLKnCh0PXg2IJWxenYmO4azzA0HGeDzwUcIjVbbY6khGYNZan-DOCzlgoEGx4RAKzfhwKKagZskrbmu7K4Vt9cZQ9TkHLq5vqPexUfMmQ5MhsaAsd71CbC1aTTqVoskCeNjFchYd1BwBC6H7nnMhs_BVdHGTpz361F5z1D3QiykXlk3GMsE5FYASuepPY_EfOVHK48rbpx-Libj2Q7p-vgN2oTC-1zDeGRF72XWO4sMShFjmdRSyd401eapWzclDzpLbh8AVjVGhr2dQk-7jtVkEaHJ99P6DZJZf1W1bSbeCfaFy2GNaLUd97BJ_6s8XZrkqLEnfVNu9bMRMtw",
  //     },
  //   }
  // );

  if (!existsSync(process.cwd() + '/res/uma-policy.json')) {
    const { data } = (await axios.post(
      'http://localhost:8080/realms/regol-eform/protocol/openid-connect/token',
      {
        grant_type: 'client_credentials',
        client_id: 'musee-du-louvre',
        client_secret: 'xpWP3QliOHMy6SZuUHL2jOgqrflp51Rs',
      },
      {
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
      },
    )) as {
      data: {
        access_token: string;
      };
    };

    writeFileSync(
      process.cwd() + '/res/uma-policy.json',
      JSON.stringify({ accessToken: data['access_token'] }),
    );
  }
  const destinationURL = '/example-postgresql/now';
  const accessToken = JSON.parse(
    readFileSync(process.cwd() + '/res/uma-policy.json', 'utf-8'),
  )?.accessToken;

  const resourceID = (
    (await axios.get(
      `http://localhost:8080/realms/regol-eform/authz/protection/resource_set?uri=${destinationURL}`,
      {
        headers: {
          Authorization: `Bearer ${accessToken}`,
        },
      },
    )) as { data: string[] }
  )?.data?.[0];
  console.log({ resourceID, status: await validatingAccess(ASRF, resourceID) });
})();
